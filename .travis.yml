language: python

jobs:

  include:

    - name: PyInstaller Build - Linux
      if: 
        - /Final Commit - v.*\.*\..*/ =~ commit_message
        -  /\[build\]/ =~ commit_message
      python: 3.8
      before_install: sudo apt install upx

    - name: PyInstaller Build - Mac
      if: 
        - /Final Commit - v.*\.*\..*/ =~ commit_message
        -  /\[build\]/ =~ commit_message
      os: osx
      osx_image: xcode11
      language: shell
      before_install: brew install upx
      
    - name: PyInstaller Build - Windows 32 bit
      if: 
        - /Final Commit - v.*\.*\..*/ =~ commit_message
        -  /\[build\]/ =~ commit_message
      os: windows
      language: shell
      env: PATH=/c/Python38:/c/Python38/Scripts:$PATH
      before_install:
        - choco install python --version 3.8.0 --forcex86
        - choco install upx

    - name: PyInstaller Build - Windows 64 bit
      if: 
        - /Final Commit - v.*\.*\..*/ =~ commit_message
        -  /\[build\]/ =~ commit_message
      os: windows
      language: shell
      env: PATH=/c/Python38:/c/Python38/Scripts:$PATH
      before_install:
        - choco install python --version 3.8.0
        - choco install upx

install:
  - pip3 install --upgrade --user PyInstaller
  - pip3 install --upgrade --user -r requirements.txt

before_script: 
  - cp main.py .test/main.py
  - cp fileio.py .test/fileio.py
  - cp settings.py .test/settings.py
  - cp main.qml .test/main.qml
  - cp settings.toml .test/settings.toml
  - cp -r icons .test/icons
  - python3 -m PyInstaller .test/JNote.spec || python -m PyInstaller .test/JNote.spec
  - python3 .test/compres.py dist/JNote --level 9 --verbose --upx-path upx || python .test/compres.py dist/JNote --level 9 --verbose --upx-path upx

script: QT_DEBUG_PLUGINS=1 dist/JNote/JNote